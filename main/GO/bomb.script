
local charged_combo_count, charged_combo_score, charged_emoji_count




function init(self)
	local type

	self.active    = true
	self.sprite    = msg.url(nil, go.get_id(), "sprite")
	self.collision = msg.url(nil, go.get_id(), "collide_emoji")
	self.blast     = msg.url(nil, go.get_id(), "blast")

	type = not dark_mode and "" or "_dark"
	self.particle  = msg.url(nil, go.get_id(), "explosion"..type)

	msg.post(self.blast, "disable")
end




function on_message(self, message_id, message)
	if message_id == hash("collision_response") and self.active then
		local pos = go.get_position()
		charged_combo_count, charged_combo_score, charged_emoji_count = 0, 0, 0

		if message.group == hash("weapon") then
			self.active = false
			allow_combo_counter = false
			score = score + bullet_miss
			msg.post(self.collision, "disable")
			go.set(self.sprite, "tint.w", 0)
			go.set_rotation(vmath.quat_rotation_z(math.random(1, 360)), self.sprite)
			go.set_scale(2, self.particle)

			msg.post(self.blast, "enable")
			timer.delay(0.1, false, function()
				allow_combo_counter = true
				msg.post(self.blast, "disable")
				factory.create("/bomb#wavepush_factory")
				if allow_combo_counter and charged_combo_count > 0 then
					msg.post("game_layer2:/main#ctrl", "show charged_combo display", {amount = charged_combo_count, score = charged_combo_score, charged = charged_emoji_count})
				end
			end)

			go.set_position(vmath.vector3(pos.x, pos.y, 0.9), self.particle)
			sound.play("/bomb#explode"..math.random(1, 2), {speed = proxy_speed})
			sound.play("/bomb#explode_echo"..math.random(1, 2), {speed = proxy_speed, delay = .4})
			particlefx.play(self.particle)
		end




	elseif message_id == hash("count charged_kill") then
		charged_combo_count = charged_combo_count + 1
		if message.charged then charged_emoji_count = charged_emoji_count + 1 end
		charged_combo_score = charged_combo_score + message.score




	elseif message_id == hash("clean_bombs") then
		for _,a in ipairs(bomb_table) do
			go.delete(a)
		end
	end
end